# ç¬‘ã„å£°ãƒ—ãƒªã‚»ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ  - è©³ç´°è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-10-12
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆå®Œäº†ãƒ»å®Ÿè£…æº–å‚™ä¸­

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [æ„Ÿæƒ…å€¤ãƒãƒƒãƒ”ãƒ³ã‚°ä»•æ§˜](#æ„Ÿæƒ…å€¤ãƒãƒƒãƒ”ãƒ³ã‚°ä»•æ§˜)
4. [UI/UXè¨­è¨ˆ](#uiuxè¨­è¨ˆ)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
6. [æŠ€è¡“ä»•æ§˜](#æŠ€è¡“ä»•æ§˜)
7. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
8. [WebSocketãƒ—ãƒ­ãƒˆã‚³ãƒ«](#websocketãƒ—ãƒ­ãƒˆã‚³ãƒ«)
9. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
10. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
11. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ãƒ†ã‚¹ãƒˆè¨ˆç”»)

---

## æ¦‚è¦

### ç›®çš„

è¦–è´è€…ã®æ„Ÿæƒ…å€¤ï¼ˆintensityï¼‰ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸç¬‘ã„å£°ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è‡ªå‹•çš„ã«å†ç”Ÿã™ã‚‹ã“ã¨ã§ã€ã€Œç¬‘ã„ã®å…±æœ‰ä½“é¨“ã€ã‚’å®Ÿç¾ã™ã‚‹ã€‚

### ä¸»è¦æ©Ÿèƒ½

1. **æ„Ÿæƒ…å€¤ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼**: Î”intensityï¼ˆå¤‰åŒ–é‡ï¼‰ãŒé–¾å€¤ã‚’è¶…ãˆãŸã¨ãã«ç¬‘ã„å£°ã‚’å†ç”Ÿ
2. **ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ**: 6ç¨®é¡ã®ç¬‘ã„å£°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ
3. **ãƒ¬ãƒ™ãƒ«è‡ªå‹•åˆ¤å®š**: æ„Ÿæƒ…å€¤ã®å¼·ã•ã«å¿œã˜ã¦ small/medium/large ã‚’è‡ªå‹•é¸æŠ
4. **å…¨å“¡å…±æœ‰**: é…ä¿¡è€…ãƒ»è¦–è´è€…å…¨å“¡ãŒå…¨å“¡ã®ç¬‘ã„å£°ã‚’èã

### ä¸»è¦ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript + IndexedDB
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Go Signaling Server (æ—¢å­˜)
- **é€šä¿¡**: WebSocket (æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©æ´»ç”¨)
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: IndexedDB (ãƒ–ãƒ©ã‚¦ã‚¶ãƒ­ãƒ¼ã‚«ãƒ«)

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lobby Screen                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Laugh Preset Selector (Avatar Grid)             â”‚  â”‚
â”‚  â”‚  ğŸ˜„ Male1  ğŸ˜† Male2  ğŸ¤£ Male3                    â”‚  â”‚
â”‚  â”‚  ğŸ˜Š Female1 ğŸ˜ Female2 ğŸ˜‚ Female3                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â†“ User selects pattern                      â”‚
â”‚  [Save to LocalStorage: laughPattern="male1"]           â”‚
â”‚             â†“                                            â”‚
â”‚  [Download all 18 presets to IndexedDB]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Session Screen (é…ä¿¡ç”»é¢)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MediaPipe Face Detection                       â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Emotion Intensity Calculation                  â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Laugh Trigger Logic                           â”‚   â”‚
â”‚  â”‚   (Î”intensity >= 10)                           â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Level Determination (small/medium/large)       â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Play Audio from IndexedDB                     â”‚   â”‚
â”‚  â”‚      +                                          â”‚   â”‚
â”‚  â”‚  Send WebSocket Message                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocket Message Handler                      â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Receive Other User's Laugh                    â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Fetch Audio from IndexedDB                    â”‚   â”‚
â”‚  â”‚      â†“                                          â”‚   â”‚
â”‚  â”‚  Play Audio                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layer                 â”‚
â”‚  - LobbyView (ç¬‘ã„å£°é¸æŠUI)         â”‚
â”‚  - SessionView (é…ä¿¡ç”»é¢)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Logic Layer            â”‚
â”‚  - useLaughPresets (Hook)           â”‚
â”‚  - useLaughPlayer (Hook)            â”‚
â”‚  - LaughTriggerLogic                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Access Layer                  â”‚
â”‚  - LaughPresetService               â”‚
â”‚  - IndexedDBManager                 â”‚
â”‚  - WebSocketClient (æ—¢å­˜)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storage / Communication            â”‚
â”‚  - IndexedDB (Browser)              â”‚
â”‚  - WebSocket (Go Signaling Server)  â”‚
â”‚  - LocalStorage (Settings)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ„Ÿæƒ…å€¤ãƒãƒƒãƒ”ãƒ³ã‚°ä»•æ§˜

### Intensity â†’ Level ãƒãƒƒãƒ”ãƒ³ã‚°

| Intensityç¯„å›² | ãƒ¬ãƒ™ãƒ« | èª¬æ˜ | å‹•ä½œ |
|--------------|--------|------|------|
| 0 - 19 | `null` (ç„¡éŸ³) | ç¬‘ã£ã¦ã„ã‚‹ãŒå£°ã¯å‡ºãªã„çŠ¶æ…‹ | éŸ³å£°å†ç”Ÿãªã— |
| 20 - 39 | `small` | å°ç¬‘ã„ | `{pattern}_small.wav` å†ç”Ÿ |
| 40 - 69 | `medium` | ä¸­ç¬‘ã„ | `{pattern}_medium.wav` å†ç”Ÿ |
| 70 - 100 | `large` | å¤§ç¬‘ã„ | `{pattern}_large.wav` å†ç”Ÿ |

**å¢ƒç•Œå€¤ã®æ‰±ã„:**
```typescript
if (intensity < 20) â†’ null (ç„¡éŸ³)
else if (intensity < 40) â†’ small
else if (intensity < 70) â†’ medium
else â†’ large
```

### ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶

ç¬‘ã„å£°ã‚’å†ç”Ÿã™ã‚‹ã‹ã©ã†ã‹ã¯ã€**Î”intensityï¼ˆå¤‰åŒ–é‡ï¼‰**ã§åˆ¤å®šã™ã‚‹ã€‚

```typescript
Î”intensity = currentIntensity - previousIntensity

if (Î”intensity >= 10) {
  // ç¬‘ã„å£°ã‚’ãƒˆãƒªã‚¬ãƒ¼
  playLaugh(currentIntensity);
} else {
  // ã˜ã‚“ã‚ã‚Šç¬‘ã„ï¼ˆç„¡éŸ³ï¼‰
}
```

**ç†ç”±:**
- æ€¥æ¿€ã«ç¬‘ã£ãŸå ´åˆã®ã¿å£°ã‚’å‡ºã™ â†’ è‡ªç„¶ãªç¬‘ã„å£°
- ã˜ã‚ã˜ã‚ç¬‘ã†å ´åˆã¯å£°ã«ãªã‚‰ãªã„ â†’ ã‚¹ãƒ‘ãƒ é˜²æ­¢

### å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ª

#### ã‚·ãƒŠãƒªã‚ª1: æ€¥æ¿€ã«ç¬‘ã†ï¼ˆå£°ãŒå‡ºã‚‹ï¼‰

```
t=0: intensity=15, previousIntensity=0
  â†’ Î”=15 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 15 < 20 â†’ ç„¡éŸ³
  â†’ å†ç”Ÿã—ãªã„

t=1: intensity=35, previousIntensity=15
  â†’ Î”=20 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 20 <= 35 < 40 â†’ small
  â†’ male1_small.wav å†ç”Ÿ ğŸ”Š
```

#### ã‚·ãƒŠãƒªã‚ª2: ã˜ã‚ã˜ã‚ç¬‘ã†ï¼ˆå£°ã¯å‡ºãªã„ï¼‰

```
t=0: intensity=15, previousIntensity=0
  â†’ Î”=15 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 15 < 20 â†’ ç„¡éŸ³
  â†’ å†ç”Ÿã—ãªã„

t=1: intensity=22, previousIntensity=15
  â†’ Î”=7 < 10 âŒ
  â†’ å†ç”Ÿã—ãªã„

t=2: intensity=28, previousIntensity=22
  â†’ Î”=6 < 10 âŒ
  â†’ å†ç”Ÿã—ãªã„
```

#### ã‚·ãƒŠãƒªã‚ª3: å¤§çˆ†ç¬‘

```
t=0: intensity=30, previousIntensity=0
  â†’ Î”=30 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 20 <= 30 < 40 â†’ small
  â†’ male1_small.wav å†ç”Ÿ ğŸ”Š

t=1: intensity=85, previousIntensity=30
  â†’ Î”=55 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 85 >= 70 â†’ large
  â†’ male1_large.wav å†ç”Ÿ ğŸ”ŠğŸ”Š
```

#### ã‚·ãƒŠãƒªã‚ª4: ç¶™ç¶šçš„ã«ç¬‘ã£ã¦ã„ã‚‹ï¼ˆãƒˆãƒªã‚¬ãƒ¼ã—ãªã„ï¼‰

```
t=0: intensity=60, previousIntensity=0
  â†’ Î”=60 >= 10 âœ…
  â†’ ãƒ¬ãƒ™ãƒ«åˆ¤å®š: 40 <= 60 < 70 â†’ medium
  â†’ male1_medium.wav å†ç”Ÿ ğŸ”Š

t=1: intensity=65, previousIntensity=60
  â†’ Î”=5 < 10 âŒ
  â†’ å†ç”Ÿã—ãªã„ï¼ˆç¶™ç¶šç¬‘ã„ã¯ã‚¹ãƒ‘ãƒ é˜²æ­¢ï¼‰

t=2: intensity=68, previousIntensity=65
  â†’ Î”=3 < 10 âŒ
  â†’ å†ç”Ÿã—ãªã„
```

### previousIntensity ã®åˆæœŸå€¤

```typescript
// åˆæœŸå€¤ã¯ 0 ã¨ã™ã‚‹
const [previousIntensity, setPreviousIntensity] = useState<number>(0);

// åˆå›ãƒ•ãƒ¬ãƒ¼ãƒ 
t=0: intensity=50, previousIntensity=0
  â†’ Î”=50 >= 10 âœ…
  â†’ ãƒˆãƒªã‚¬ãƒ¼ç™ºç«
```

---

## UI/UXè¨­è¨ˆ

### ãƒ­ãƒ“ãƒ¼ç”»é¢ - ç¬‘ã„å£°é¸æŠUI

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   lolup Live                           â”‚
â”‚                                                        â”‚
â”‚        ã‚ãªãŸã®ç¬‘ã„å£°ã‚’é¸ã‚“ã§ãã ã•ã„ ğŸ˜„               â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   ğŸ˜„     â”‚  â”‚   ğŸ˜†     â”‚  â”‚   ğŸ¤£     â”‚           â”‚
â”‚  â”‚  ç”·æ€§1   â”‚  â”‚  ç”·æ€§2   â”‚  â”‚  ç”·æ€§3   â”‚           â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚           â”‚
â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â†‘ é¸æŠä¸­ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰                           â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   ğŸ˜Š     â”‚  â”‚   ğŸ˜     â”‚  â”‚   ğŸ˜‚     â”‚           â”‚
â”‚  â”‚  å¥³æ€§1   â”‚  â”‚  å¥³æ€§2   â”‚  â”‚  å¥³æ€§3   â”‚           â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚           â”‚
â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚  â”‚ [â–¶ï¸ è©¦è´] â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚
â”‚  [ ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... 12/18 ]               â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚      é…ä¿¡ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹                   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

1. **é¸æŠ**: ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼‰
2. **è©¦è´**: å„ã‚«ãƒ¼ãƒ‰ã®ã€Œâ–¶ï¸ è©¦è´ã€ãƒœã‚¿ãƒ³ã§ mediumï¼ˆä¸­ç¬‘ã„ï¼‰ã‚’å†ç”Ÿ
3. **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²è¡ŒçŠ¶æ³**: ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã¯ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
4. **å…¥å®¤**: ã€Œé…ä¿¡ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹ã€ãƒœã‚¿ãƒ³ã§é…ä¿¡ç”»é¢ã¸é·ç§»

#### çŠ¶æ…‹ç®¡ç†

```typescript
interface LobbyState {
  selectedPattern: string;           // "male1"
  presets: LaughPreset[];            // å…¨18ãƒ—ãƒªã‚»ãƒƒãƒˆ
  downloadProgress: number;          // 0-18
  isDownloading: boolean;
  downloadError: string | null;
}
```

### é…ä¿¡ç”»é¢ - ç¬‘ã„å£°å†ç”Ÿï¼ˆUIå¤‰æ›´ãªã—ï¼‰

é…ä¿¡ç”»é¢ã§ã¯**UIå¤‰æ›´ãªã—**ã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¬‘ã„å£°ãŒå†ç”Ÿã•ã‚Œã‚‹ã€‚

**è¡¨ç¤ºä¾‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãƒ»æœ¬ç•ªã§ã¯éè¡¨ç¤ºå¯ï¼‰:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥ é…ä¿¡ä¸­                  â”‚
â”‚                             â”‚
â”‚  [ã‚ãªãŸ]                   â”‚
â”‚  ç¬‘ã„å¼·åº¦: 65 (medium)      â”‚
â”‚  ğŸ“¢ ãƒãƒãƒ... (å†ç”Ÿä¸­)      â”‚
â”‚                             â”‚
â”‚  [è¦–è´è€…A - female2]        â”‚
â”‚  ğŸ“¢ ã‚¢ãƒãƒãƒ... (å†ç”Ÿä¸­)    â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. ãƒ­ãƒ“ãƒ¼ç”»é¢ã§ã®ãƒ—ãƒªã‚»ãƒƒãƒˆæº–å‚™

```mermaid
sequenceDiagram
    participant User
    participant LobbyView
    participant LaughPresetService
    participant GoServer
    participant IndexedDB

    User->>LobbyView: ãƒ­ãƒ“ãƒ¼ç”»é¢è¡¨ç¤º
    LobbyView->>LaughPresetService: fetchPresets()
    LaughPresetService->>GoServer: GET /api/v1/laugh/presets
    GoServer-->>LaughPresetService: 18å€‹ã®ãƒ—ãƒªã‚»ãƒƒãƒˆæƒ…å ±
    LaughPresetService-->>LobbyView: presets[]

    LobbyView->>User: é¸æŠUIè¡¨ç¤º
    User->>LobbyView: male1 ã‚’é¸æŠ
    LobbyView->>LocalStorage: save "male1"

    User->>LobbyView: è©¦è´ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    LobbyView->>GoServer: GET /static/laughs/presets/male1_medium.wav
    GoServer-->>LobbyView: Audio data
    LobbyView->>User: éŸ³å£°å†ç”Ÿ

    LobbyView->>LaughPresetService: downloadAllPresets()
    loop 18 presets
        LaughPresetService->>GoServer: GET /static/laughs/presets/{id}.wav
        GoServer-->>LaughPresetService: Audio ArrayBuffer
        LaughPresetService->>IndexedDB: save(presetId, audioData)
    end
    LaughPresetService-->>LobbyView: Download complete

    User->>LobbyView: é…ä¿¡ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹
    LobbyView->>SessionView: Navigate
```

### 2. é…ä¿¡ç”»é¢ã§ã®ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼ï¼ˆè‡ªåˆ†ï¼‰

```mermaid
sequenceDiagram
    participant MediaPipe
    participant SessionView
    participant LaughTrigger
    participant IndexedDB
    participant Audio
    participant WebSocket

    MediaPipe->>SessionView: intensity=65
    SessionView->>LaughTrigger: checkTrigger(65, prev=50)
    LaughTrigger->>LaughTrigger: Î”=15 >= 10 âœ…
    LaughTrigger->>LaughTrigger: level=medium (40<=65<70)
    LaughTrigger->>SessionView: trigger("male1_medium")

    SessionView->>IndexedDB: getPreset("male1_medium")
    IndexedDB-->>SessionView: audioData
    SessionView->>Audio: play(audioData)
    Audio-->>SessionView: Playing...

    SessionView->>WebSocket: send({ type: "laugh:trigger", presetId: "male1_medium" })

    SessionView->>LaughTrigger: updatePrevious(65)
```

### 3. é…ä¿¡ç”»é¢ã§ã®ç¬‘ã„å£°å—ä¿¡ï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

```mermaid
sequenceDiagram
    participant WebSocket
    participant SessionView
    participant IndexedDB
    participant Audio

    WebSocket->>SessionView: message { type: "laugh:trigger", userId: "user_123", presetId: "female2_large" }
    SessionView->>IndexedDB: getPreset("female2_large")
    IndexedDB-->>SessionView: audioData
    SessionView->>Audio: play(audioData)
    Audio-->>SessionView: Playing...
```

---

## æŠ€è¡“ä»•æ§˜

### ãƒ—ãƒªã‚»ãƒƒãƒˆæƒ…å ±

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ6ç¨®é¡ï¼‰

| Pattern ID | è¡¨ç¤ºå | èª¬æ˜ |
|-----------|--------|------|
| `male1` | ç”·æ€§1 | æ˜ã‚‹ã„ç”·æ€§ã®ç¬‘ã„å£° |
| `male2` | ç”·æ€§2 | è½ã¡ç€ã„ãŸç”·æ€§ã®ç¬‘ã„å£° |
| `male3` | ç”·æ€§3 | è±ªå¿«ãªç”·æ€§ã®ç¬‘ã„å£° |
| `female1` | å¥³æ€§1 | æ˜ã‚‹ã„å¥³æ€§ã®ç¬‘ã„å£° |
| `female2` | å¥³æ€§2 | ä¸Šå“ãªå¥³æ€§ã®ç¬‘ã„å£° |
| `female3` | å¥³æ€§3 | å…ƒæ°—ãªå¥³æ€§ã®ç¬‘ã„å£° |

#### ãƒ¬ãƒ™ãƒ«ï¼ˆ3ç¨®é¡ï¼‰

| Level | ãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ | èª¬æ˜ |
|-------|---------------------|------|
| `small` | `_small.wav` | å°ç¬‘ã„ï¼ˆintensity 20-39ï¼‰ |
| `medium` | `_medium.wav` | ä¸­ç¬‘ã„ï¼ˆintensity 40-69ï¼‰ |
| `large` | `_large.wav` | å¤§ç¬‘ã„ï¼ˆintensity 70-100ï¼‰ |

#### ãƒ—ãƒªã‚»ãƒƒãƒˆIDå‘½åè¦å‰‡

```
{pattern}_{level}

ä¾‹:
- male1_small
- male1_medium
- male1_large
- female2_small
- female2_medium
- female2_large
```

**åˆè¨ˆ: 6ãƒ‘ã‚¿ãƒ¼ãƒ³ Ã— 3ãƒ¬ãƒ™ãƒ« = 18ãƒ—ãƒªã‚»ãƒƒãƒˆ**

### APIä»•æ§˜ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰

#### 1. ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§å–å¾—

```http
GET /api/v1/laugh/presets
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
  "presets": [
    {
      "id": "male1_small",
      "pattern": "male1",
      "level": "small",
      "url": "/static/laughs/presets/male1_small.wav",
      "duration": 1.2,
      "size": 114688
    },
    ...
  ]
}
```

#### 2. ãƒ—ãƒªã‚»ãƒƒãƒˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—

```http
GET /static/laughs/presets/{presetId}.wav
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
- Content-Type: `audio/wav`
- Body: WAVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿

### IndexedDB ã‚¹ã‚­ãƒ¼ãƒ

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±

```typescript
const DB_NAME = 'LolupLiveDB';
const DB_VERSION = 1;
const STORE_NAME = 'laughPresets';
```

#### Object Store ã‚¹ã‚­ãƒ¼ãƒ

```typescript
interface LaughPresetDB {
  id: string;              // Primary Key: "male1_small"
  pattern: string;         // "male1"
  level: string;           // "small" | "medium" | "large"
  duration: number;        // 1.2 (ç§’)
  size: number;            // 114688 (ãƒã‚¤ãƒˆ)
  audioData: ArrayBuffer;  // WAVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿
  downloadedAt: number;    // Unix timestamp
}
```

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```typescript
objectStore.createIndex('pattern', 'pattern', { unique: false });
objectStore.createIndex('level', 'level', { unique: false });
```

### LocalStorage ã‚¹ã‚­ãƒ¼ãƒ

```typescript
interface LaughSettings {
  selectedPattern: string;  // "male1"
  version: string;          // "1.0"
  updatedAt: number;        // Unix timestamp
}

// Key: "lolup_laugh_settings"
localStorage.setItem('lolup_laugh_settings', JSON.stringify(settings));
```

---

## å®Ÿè£…è©³ç´°

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ laugh/
â”‚       â”œâ”€â”€ LaughPresetService.ts      # ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
â”‚       â”œâ”€â”€ IndexedDBManager.ts        # IndexedDBæ“ä½œ
â”‚       â””â”€â”€ LaughPlayer.ts             # éŸ³å£°å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useLaughPresets.ts             # ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—Hook
â”‚   â””â”€â”€ useLaughPlayer.ts              # ç¬‘ã„å£°å†ç”ŸHook
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ lobby/
â”‚   â”‚   â””â”€â”€ LaughPresetSelector.tsx   # ç¬‘ã„å£°é¸æŠUI
â”‚   â””â”€â”€ session/
â”‚       â””â”€â”€ SessionView.tsx            # é…ä¿¡ç”»é¢ï¼ˆæ—¢å­˜ã«è¿½åŠ ï¼‰
â””â”€â”€ types/
    â””â”€â”€ laugh.ts                       # å‹å®šç¾©
```

### å‹å®šç¾© (types/laugh.ts)

```typescript
// ãƒ—ãƒªã‚»ãƒƒãƒˆæƒ…å ±ï¼ˆAPIå–å¾—ç”¨ï¼‰
export interface LaughPreset {
  id: string;           // "male1_small"
  pattern: string;      // "male1"
  level: string;        // "small" | "medium" | "large"
  url: string;          // "/static/laughs/presets/male1_small.wav"
  duration: number;     // 1.2
  size: number;         // 114688
}

// ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§APIãƒ¬ã‚¹ãƒãƒ³ã‚¹
export interface PresetsResponse {
  presets: LaughPreset[];
}

// IndexedDBä¿å­˜ç”¨
export interface LaughPresetDB {
  id: string;
  pattern: string;
  level: string;
  duration: number;
  size: number;
  audioData: ArrayBuffer;
  downloadedAt: number;
}

// LocalStorageä¿å­˜ç”¨
export interface LaughSettings {
  selectedPattern: string;
  version: string;
  updatedAt: number;
}

// ç¬‘ã„å£°ãƒ¬ãƒ™ãƒ«
export type LaughLevel = 'small' | 'medium' | 'large';

// ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼çµæœ
export interface LaughTriggerResult {
  shouldTrigger: boolean;
  level: LaughLevel | null;
  presetId: string | null;  // "male1_medium"
}
```

### IndexedDBManager (services/laugh/IndexedDBManager.ts)

```typescript
const DB_NAME = 'LolupLiveDB';
const DB_VERSION = 1;
const STORE_NAME = 'laughPresets';

export class IndexedDBManager {
  private db: IDBDatabase | null = null;

  /**
   * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã
   */
  async open(): Promise<IDBDatabase> {
    if (this.db) return this.db;

    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve(request.result);
      };

      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;

        // Object Storeã‚’ä½œæˆ
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          objectStore.createIndex('pattern', 'pattern', { unique: false });
          objectStore.createIndex('level', 'level', { unique: false });
        }
      };
    });
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜
   */
  async savePreset(preset: LaughPresetDB): Promise<void> {
    const db = await this.open();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const request = store.put(preset);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
   */
  async getPreset(presetId: string): Promise<LaughPresetDB | null> {
    const db = await this.open();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const request = store.get(presetId);
      request.onsuccess = () => resolve(request.result || null);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
   */
  async getAllPresets(): Promise<LaughPresetDB[]> {
    const db = await this.open();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
   */
  async deletePreset(presetId: string): Promise<void> {
    const db = await this.open();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const request = store.delete(presetId);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  /**
   * å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤
   */
  async clearAll(): Promise<void> {
    const db = await this.open();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const request = store.clear();
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }
}
```

### LaughPresetService (services/laugh/LaughPresetService.ts)

```typescript
import { IndexedDBManager } from './IndexedDBManager';
import type { LaughPreset, PresetsResponse, LaughPresetDB } from '../../types/laugh';

const LAUGH_API_URL = import.meta.env.VITE_LAUGH_API_URL || 'http://localhost:5001';
const STATIC_BASE_URL = import.meta.env.VITE_STATIC_BASE_URL || 'http://localhost:8080';

export class LaughPresetService {
  private dbManager: IndexedDBManager;

  constructor() {
    this.dbManager = new IndexedDBManager();
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆAPIã‹ã‚‰ï¼‰
   */
  async fetchPresets(): Promise<LaughPreset[]> {
    try {
      const response = await fetch(`${LAUGH_API_URL}/api/v1/laugh/presets`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data: PresetsResponse = await response.json();
      return data.presets;
    } catch (error) {
      console.error('Failed to fetch presets:', error);
      throw error;
    }
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   */
  async downloadPresetAudio(url: string): Promise<ArrayBuffer> {
    try {
      const fullUrl = `${STATIC_BASE_URL}${url}`;
      const response = await fetch(fullUrl);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.arrayBuffer();
    } catch (error) {
      console.error('Failed to download audio:', error);
      throw error;
    }
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’IndexedDBã«ä¿å­˜
   */
  async savePreset(preset: LaughPreset, audioData: ArrayBuffer): Promise<void> {
    const data: LaughPresetDB = {
      id: preset.id,
      pattern: preset.pattern,
      level: preset.level,
      duration: preset.duration,
      size: preset.size,
      audioData: audioData,
      downloadedAt: Date.now()
    };

    await this.dbManager.savePreset(data);
  }

  /**
   * å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
   */
  async downloadAllPresets(
    presets: LaughPreset[],
    onProgress?: (current: number, total: number) => void
  ): Promise<void> {
    const total = presets.length;

    for (let i = 0; i < total; i++) {
      const preset = presets[i];
      try {
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const audioData = await this.downloadPresetAudio(preset.url);

        // IndexedDBã«ä¿å­˜
        await this.savePreset(preset, audioData);

        // é€²è¡ŒçŠ¶æ³ã‚’é€šçŸ¥
        onProgress?.(i + 1, total);

        console.log(`Downloaded: ${preset.id} (${i + 1}/${total})`);
      } catch (error) {
        console.error(`Failed to download ${preset.id}:`, error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶šï¼ˆæ¬¡ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      }
    }
  }

  /**
   * IndexedDBã‹ã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
   */
  async getPreset(presetId: string): Promise<LaughPresetDB | null> {
    return await this.dbManager.getPreset(presetId);
  }

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
   */
  async getAllCachedPresets(): Promise<LaughPresetDB[]> {
    return await this.dbManager.getAllPresets();
  }
}
```

### LaughPlayer (services/laugh/LaughPlayer.ts)

```typescript
import { LaughPresetService } from './LaughPresetService';
import type { LaughLevel, LaughTriggerResult } from '../../types/laugh';

export class LaughPlayer {
  private presetService: LaughPresetService;
  private previousIntensity: number = 0;

  constructor() {
    this.presetService = new LaughPresetService();
  }

  /**
   * ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®šã¨ãƒ¬ãƒ™ãƒ«æ±ºå®š
   */
  checkTrigger(currentIntensity: number): LaughTriggerResult {
    const delta = currentIntensity - this.previousIntensity;

    // ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®š
    if (delta < 10) {
      this.previousIntensity = currentIntensity;
      return {
        shouldTrigger: false,
        level: null,
        presetId: null
      };
    }

    // ãƒ¬ãƒ™ãƒ«åˆ¤å®š
    let level: LaughLevel | null = null;

    if (currentIntensity < 20) {
      level = null; // ç„¡éŸ³
    } else if (currentIntensity < 40) {
      level = 'small';
    } else if (currentIntensity < 70) {
      level = 'medium';
    } else {
      level = 'large';
    }

    this.previousIntensity = currentIntensity;

    return {
      shouldTrigger: level !== null,
      level,
      presetId: null // å¾Œã§patternã¨çµ„ã¿åˆã‚ã›ã‚‹
    };
  }

  /**
   * éŸ³å£°ã‚’å†ç”Ÿï¼ˆArrayBufferã‹ã‚‰ï¼‰
   */
  async playAudioFromBuffer(audioData: ArrayBuffer): Promise<void> {
    try {
      const blob = new Blob([audioData], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);

      const audio = new Audio(url);
      await audio.play();

      // å†ç”Ÿçµ‚äº†å¾Œã«URLã‚’è§£æ”¾
      audio.onended = () => {
        URL.revokeObjectURL(url);
      };
    } catch (error) {
      console.error('Failed to play audio:', error);
      throw error;
    }
  }

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆIDã§éŸ³å£°ã‚’å†ç”Ÿ
   */
  async playPreset(presetId: string): Promise<void> {
    try {
      // IndexedDBã‹ã‚‰å–å¾—
      const preset = await this.presetService.getPreset(presetId);

      if (!preset) {
        throw new Error(`Preset not found: ${presetId}`);
      }

      // å†ç”Ÿ
      await this.playAudioFromBuffer(preset.audioData);
    } catch (error) {
      console.error(`Failed to play preset ${presetId}:`, error);
      throw error;
    }
  }

  /**
   * previousIntensityã‚’ãƒªã‚»ãƒƒãƒˆ
   */
  resetIntensity(): void {
    this.previousIntensity = 0;
  }

  /**
   * previousIntensityã‚’å–å¾—
   */
  getPreviousIntensity(): number {
    return this.previousIntensity;
  }
}
```

### useLaughPresets Hook (hooks/useLaughPresets.ts)

```typescript
import { useState, useEffect, useCallback } from 'react';
import { LaughPresetService } from '../services/laugh/LaughPresetService';
import type { LaughPreset } from '../types/laugh';

export const useLaughPresets = () => {
  const [presets, setPresets] = useState<LaughPreset[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  const [downloadProgress, setDownloadProgress] = useState<number>(0);
  const [isDownloading, setIsDownloading] = useState(false);

  const presetService = new LaughPresetService();

  // ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—
  useEffect(() => {
    const loadPresets = async () => {
      try {
        setLoading(true);
        const fetchedPresets = await presetService.fetchPresets();
        setPresets(fetchedPresets);
      } catch (err) {
        setError(err as Error);
      } finally {
        setLoading(false);
      }
    };

    loadPresets();
  }, []);

  // å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const downloadAllPresets = useCallback(async () => {
    try {
      setIsDownloading(true);
      setDownloadProgress(0);

      await presetService.downloadAllPresets(presets, (current, total) => {
        setDownloadProgress(current);
      });

      console.log('All presets downloaded successfully');
    } catch (err) {
      console.error('Failed to download presets:', err);
      throw err;
    } finally {
      setIsDownloading(false);
    }
  }, [presets]);

  return {
    presets,
    loading,
    error,
    downloadProgress,
    isDownloading,
    downloadAllPresets
  };
};
```

### useLaughPlayer Hook (hooks/useLaughPlayer.ts)

```typescript
import { useCallback, useRef } from 'react';
import { LaughPlayer } from '../services/laugh/LaughPlayer';
import type { LaughLevel } from '../types/laugh';

interface UseLaughPlayerOptions {
  selectedPattern: string;  // "male1"
  onLaughTriggered?: (presetId: string, level: LaughLevel) => void;
}

export const useLaughPlayer = (options: UseLaughPlayerOptions) => {
  const { selectedPattern, onLaughTriggered } = options;
  const playerRef = useRef<LaughPlayer>(new LaughPlayer());

  /**
   * æ„Ÿæƒ…å€¤ã‚’å‡¦ç†ã—ã¦ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®š
   */
  const processIntensity = useCallback(async (intensity: number) => {
    const player = playerRef.current;
    const result = player.checkTrigger(intensity);

    if (result.shouldTrigger && result.level) {
      const presetId = `${selectedPattern}_${result.level}`;

      try {
        // éŸ³å£°å†ç”Ÿ
        await player.playPreset(presetId);

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        onLaughTriggered?.(presetId, result.level);
      } catch (error) {
        console.error('Failed to play laugh:', error);
      }
    }
  }, [selectedPattern, onLaughTriggered]);

  /**
   * ãƒ—ãƒªã‚»ãƒƒãƒˆIDã§ç›´æ¥å†ç”Ÿï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¬‘ã„å£°å—ä¿¡æ™‚ï¼‰
   */
  const playPreset = useCallback(async (presetId: string) => {
    try {
      await playerRef.current.playPreset(presetId);
    } catch (error) {
      console.error(`Failed to play preset ${presetId}:`, error);
    }
  }, []);

  /**
   * previousIntensityã‚’ãƒªã‚»ãƒƒãƒˆ
   */
  const resetIntensity = useCallback(() => {
    playerRef.current.resetIntensity();
  }, []);

  return {
    processIntensity,
    playPreset,
    resetIntensity
  };
};
```

### LaughPresetSelector Component (components/lobby/LaughPresetSelector.tsx)

```typescript
import React, { useState, useEffect } from 'react';
import { useLaughPresets } from '../../hooks/useLaughPresets';
import { LaughPlayer } from '../../services/laugh/LaughPlayer';

const PATTERNS = [
  { id: 'male1', label: 'ç”·æ€§1', emoji: 'ğŸ˜„' },
  { id: 'male2', label: 'ç”·æ€§2', emoji: 'ğŸ˜†' },
  { id: 'male3', label: 'ç”·æ€§3', emoji: 'ğŸ¤£' },
  { id: 'female1', label: 'å¥³æ€§1', emoji: 'ğŸ˜Š' },
  { id: 'female2', label: 'å¥³æ€§2', emoji: 'ğŸ˜' },
  { id: 'female3', label: 'å¥³æ€§3', emoji: 'ğŸ˜‚' }
];

export const LaughPresetSelector: React.FC = () => {
  const { presets, loading, downloadProgress, isDownloading, downloadAllPresets } = useLaughPresets();
  const [selectedPattern, setSelectedPattern] = useState<string>('male1');
  const [isPlaying, setIsPlaying] = useState<string | null>(null);
  const laughPlayer = new LaughPlayer();

  // åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚: å…¨ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  useEffect(() => {
    if (presets.length > 0 && !isDownloading) {
      downloadAllPresets().catch(err => {
        console.error('Failed to download presets:', err);
      });
    }
  }, [presets, isDownloading, downloadAllPresets]);

  // ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ
  const handleSelectPattern = (patternId: string) => {
    setSelectedPattern(patternId);
    // LocalStorageã«ä¿å­˜
    localStorage.setItem('lolup_laugh_settings', JSON.stringify({
      selectedPattern: patternId,
      version: '1.0',
      updatedAt: Date.now()
    }));
  };

  // è©¦è´ï¼ˆmedium ã‚’å†ç”Ÿï¼‰
  const handlePreview = async (patternId: string) => {
    const presetId = `${patternId}_medium`;
    setIsPlaying(presetId);

    try {
      await laughPlayer.playPreset(presetId);
    } catch (error) {
      console.error('Failed to preview:', error);
    } finally {
      setIsPlaying(null);
    }
  };

  if (loading) {
    return <div>ãƒ—ãƒªã‚»ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>;
  }

  return (
    <div className="laugh-preset-selector">
      <h2>ã‚ãªãŸã®ç¬‘ã„å£°ã‚’é¸ã‚“ã§ãã ã•ã„ ğŸ˜„</h2>

      <div className="pattern-grid">
        {PATTERNS.map(pattern => (
          <div
            key={pattern.id}
            className={`pattern-card ${selectedPattern === pattern.id ? 'selected' : ''}`}
            onClick={() => handleSelectPattern(pattern.id)}
          >
            <div className="emoji">{pattern.emoji}</div>
            <div className="label">{pattern.label}</div>
            <button
              className="preview-btn"
              onClick={(e) => {
                e.stopPropagation();
                handlePreview(pattern.id);
              }}
              disabled={isPlaying === `${pattern.id}_medium`}
            >
              {isPlaying === `${pattern.id}_medium` ? 'å†ç”Ÿä¸­...' : 'â–¶ï¸ è©¦è´'}
            </button>
          </div>
        ))}
      </div>

      {isDownloading && (
        <div className="download-progress">
          ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... {downloadProgress}/{presets.length}
        </div>
      )}

      <button
        className="enter-room-btn"
        disabled={isDownloading}
      >
        é…ä¿¡ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹
      </button>
    </div>
  );
};
```

### SessionView çµ±åˆ (components/session/SessionView.tsx)

```typescript
import { useLaughPlayer } from '../../hooks/useLaughPlayer';
import { useWebSocket } from '../../hooks/useWebSocket';

// æ—¢å­˜ã®SessionViewã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¿½åŠ 

export const SessionView: React.FC = () => {
  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...

  // LocalStorageã‹ã‚‰é¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—
  const [selectedPattern, setSelectedPattern] = useState<string>(() => {
    const settings = localStorage.getItem('lolup_laugh_settings');
    if (settings) {
      const parsed = JSON.parse(settings);
      return parsed.selectedPattern || 'male1';
    }
    return 'male1';
  });

  // ç¬‘ã„å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  const { processIntensity, playPreset } = useLaughPlayer({
    selectedPattern,
    onLaughTriggered: (presetId, level) => {
      console.log(`Laugh triggered: ${presetId} (${level})`);

      // WebSocketã§ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
      if (ws) {
        ws.send(JSON.stringify({
          type: 'laugh:trigger',
          data: {
            presetId,
            timestamp: Date.now()
          },
          timestamp: Date.now()
        }));
      }
    }
  });

  // æ„Ÿæƒ…å€¤æ›´æ–°æ™‚ã«ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
  useEffect(() => {
    if (!isBroadcaster && receivedEmotions) {
      const myEmotions = receivedEmotions.get(userName);
      if (myEmotions && myEmotions.length > 0) {
        const latestEmotion = myEmotions[myEmotions.length - 1];
        const intensity = latestEmotion.intensity;

        // ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®š
        processIntensity(intensity);
      }
    }
  }, [receivedEmotions, userName, isBroadcaster, processIntensity]);

  // WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¬‘ã„å£°
  useEffect(() => {
    if (!ws) return;

    const handleMessage = (event: MessageEvent) => {
      const message = JSON.parse(event.data);

      if (message.type === 'laugh:trigger') {
        const { presetId } = message.data;
        console.log(`Other user laughed: ${presetId}`);
        playPreset(presetId);
      }
    };

    ws.addEventListener('message', handleMessage);

    return () => {
      ws.removeEventListener('message', handleMessage);
    };
  }, [ws, playPreset]);

  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
};
```

---

## WebSocketãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé€ä¿¡ï¼‰

```typescript
{
  type: 'laugh:trigger',
  data: {
    presetId: string;      // "male1_medium"
    timestamp: number;     // Date.now()
  },
  timestamp: number;
}
```

### ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå—ä¿¡ãƒ»ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼‰

```typescript
{
  type: 'laugh:trigger',
  userId: string;          // "user_123"
  data: {
    presetId: string;      // "female2_large"
    timestamp: number;
  },
  timestamp: number;
}
```

### Go Signaling Serverå´ã®å®Ÿè£…ï¼ˆå‚è€ƒï¼‰

```go
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
const (
    MessageTypeLaughTrigger = "laugh:trigger"
)

// LaughTriggerMessage
type LaughTriggerMessage struct {
    Type      string                 `json:"type"`
    UserID    string                 `json:"userId,omitempty"`
    Data      LaughTriggerData       `json:"data"`
    Timestamp int64                  `json:"timestamp"`
}

type LaughTriggerData struct {
    PresetID  string `json:"presetId"`
    Timestamp int64  `json:"timestamp"`
}

// ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
func handleLaughTrigger(client *Client, message []byte) {
    var msg LaughTriggerMessage
    if err := json.Unmarshal(message, &msg); err != nil {
        return
    }

    // ãƒ«ãƒ¼ãƒ å†…ã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
    msg.UserID = client.UserID
    broadcastToRoom(client.RoomID, msg, client.ID)
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—å¤±æ•—

```typescript
try {
  const presets = await presetService.fetchPresets();
} catch (error) {
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ—ãƒªã‚»ãƒƒãƒˆæƒ…å ±ã‚’ä½¿ç”¨
  const fallbackPresets = [
    { id: 'male1_small', pattern: 'male1', level: 'small', url: '/static/laughs/presets/male1_small.wav', duration: 1.2, size: 114688 },
    // ... æ®‹ã‚Š17å€‹
  ];
  setPresets(fallbackPresets);
}
```

### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—

```typescript
try {
  await presetService.downloadAllPresets(presets);
} catch (error) {
  // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€å¤§3å›ï¼‰
  for (let i = 0; i < 3; i++) {
    try {
      await presetService.downloadAllPresets(presets);
      break; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—çµ‚äº†
    } catch (retryError) {
      if (i === 2) {
        // 3å›å¤±æ•—ã—ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }
  }
}
```

### IndexedDBä¿å­˜å¤±æ•—

```typescript
try {
  await dbManager.savePreset(preset);
} catch (error) {
  if (error.name === 'QuotaExceededError') {
    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ä¸è¶³
    alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
  } else {
    console.error('IndexedDB save failed:', error);
  }
}
```

### éŸ³å£°å†ç”Ÿå¤±æ•—

```typescript
try {
  await laughPlayer.playPreset(presetId);
} catch (error) {
  console.error(`Failed to play ${presetId}:`, error);

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç›´æ¥ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿ
  const preset = presets.find(p => p.id === presetId);
  if (preset) {
    const audio = new Audio(`${STATIC_BASE_URL}${preset.url}`);
    await audio.play();
  }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. æ®µéšçš„ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```typescript
// å„ªå…ˆåº¦é †ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
async function downloadPresetsInPriority(
  presets: LaughPreset[],
  selectedPattern: string
) {
  // 1. è‡ªåˆ†ãŒé¸æŠã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ3ã¤: small, medium, largeï¼‰
  const myPresets = presets.filter(p => p.pattern === selectedPattern);
  for (const preset of myPresets) {
    await presetService.savePreset(preset, await presetService.downloadPresetAudio(preset.url));
  }

  // 2. æ®‹ã‚Šã®ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ï¼‰
  const otherPresets = presets.filter(p => p.pattern !== selectedPattern);
  for (const preset of otherPresets) {
    await presetService.savePreset(preset, await presetService.downloadPresetAudio(preset.url));
    await new Promise(resolve => setTimeout(resolve, 100)); // 100mså¾…æ©Ÿ
  }
}
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯

```typescript
// ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
async function ensurePresetCached(presetId: string) {
  const cached = await dbManager.getPreset(presetId);
  if (cached) {
    console.log(`Preset ${presetId} already cached`);
    return;
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const preset = presets.find(p => p.id === presetId);
  if (preset) {
    const audioData = await presetService.downloadPresetAudio(preset.url);
    await presetService.savePreset(preset, audioData);
  }
}
```

### 3. éŸ³å£°ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰

```typescript
// é »ç¹ã«ä½¿ã‚ã‚Œã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆmediumï¼‰ã‚’äº‹å‰ãƒ­ãƒ¼ãƒ‰
useEffect(() => {
  const preloadMedium = async () => {
    const mediumId = `${selectedPattern}_medium`;
    const cached = await dbManager.getPreset(mediumId);
    if (cached) {
      // ãƒ¡ãƒ¢ãƒªã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæ¬¡å›ã®å†ç”Ÿã‚’é«˜é€ŸåŒ–ï¼‰
      const blob = new Blob([cached.audioData], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.preload = 'auto';
    }
  };

  preloadMedium();
}, [selectedPattern]);
```

---

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

#### IndexedDBManager

```typescript
describe('IndexedDBManager', () => {
  let dbManager: IndexedDBManager;

  beforeEach(async () => {
    dbManager = new IndexedDBManager();
    await dbManager.open();
  });

  afterEach(async () => {
    await dbManager.clearAll();
  });

  test('ãƒ—ãƒªã‚»ãƒƒãƒˆã®ä¿å­˜ã¨å–å¾—', async () => {
    const preset: LaughPresetDB = {
      id: 'male1_small',
      pattern: 'male1',
      level: 'small',
      duration: 1.2,
      size: 114688,
      audioData: new ArrayBuffer(114688),
      downloadedAt: Date.now()
    };

    await dbManager.savePreset(preset);
    const retrieved = await dbManager.getPreset('male1_small');

    expect(retrieved).not.toBeNull();
    expect(retrieved?.id).toBe('male1_small');
  });
});
```

#### LaughPlayer

```typescript
describe('LaughPlayer', () => {
  let player: LaughPlayer;

  beforeEach(() => {
    player = new LaughPlayer();
  });

  test('ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®š: Î”intensity >= 10', () => {
    const result1 = player.checkTrigger(50);
    expect(result1.shouldTrigger).toBe(true);
    expect(result1.level).toBe('medium');

    const result2 = player.checkTrigger(55);
    expect(result2.shouldTrigger).toBe(false); // Î”=5 < 10
  });

  test('ãƒ¬ãƒ™ãƒ«åˆ¤å®š', () => {
    player.resetIntensity();

    const result1 = player.checkTrigger(15);
    expect(result1.shouldTrigger).toBe(false); // < 20

    const result2 = player.checkTrigger(35);
    expect(result2.shouldTrigger).toBe(true);
    expect(result2.level).toBe('small');

    player.resetIntensity();
    const result3 = player.checkTrigger(55);
    expect(result3.shouldTrigger).toBe(true);
    expect(result3.level).toBe('medium');

    player.resetIntensity();
    const result4 = player.checkTrigger(85);
    expect(result4.shouldTrigger).toBe(true);
    expect(result4.level).toBe('large');
  });
});
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

#### ãƒ­ãƒ“ãƒ¼ç”»é¢ â†’ é…ä¿¡ç”»é¢ãƒ•ãƒ­ãƒ¼

```typescript
describe('Laugh Preset System Integration', () => {
  test('ãƒ­ãƒ“ãƒ¼ã§ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ â†’ é…ä¿¡ç”»é¢ã§å†ç”Ÿ', async () => {
    // 1. ãƒ­ãƒ“ãƒ¼ç”»é¢: ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ
    render(<LaughPresetSelector />);
    const male1Card = screen.getByText('ç”·æ€§1');
    fireEvent.click(male1Card);

    // LocalStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    const settings = JSON.parse(localStorage.getItem('lolup_laugh_settings')!);
    expect(settings.selectedPattern).toBe('male1');

    // 2. é…ä¿¡ç”»é¢: ç¬‘ã„å£°ãƒˆãƒªã‚¬ãƒ¼
    render(<SessionView />);

    // æ„Ÿæƒ…å€¤ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    act(() => {
      // intensity=50 (Î”=50 >= 10) â†’ medium
      mockEmotionUpdate(50);
    });

    // éŸ³å£°å†ç”ŸãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    await waitFor(() => {
      expect(mockAudioPlay).toHaveBeenCalledWith('male1_medium');
    });
  });
});
```

---

## ä»˜éŒ²

### ç’°å¢ƒå¤‰æ•°è¨­å®š

**.env.development**
```env
VITE_SIGNALING_WS_URL=ws://localhost:8080/ws
VITE_SIGNALING_HTTP_URL=http://localhost:8080
VITE_LAUGH_API_URL=http://localhost:5001
VITE_STATIC_BASE_URL=http://localhost:8080
```

**.env.production**
```env
VITE_SIGNALING_WS_URL=wss://your-domain.com/ws
VITE_SIGNALING_HTTP_URL=https://your-domain.com
VITE_LAUGH_API_URL=https://your-domain.com
VITE_STATIC_BASE_URL=https://your-domain.com
```

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¾å­˜é–¢ä¿‚

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "typescript": "^5.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@vitest/ui": "^0.34.0",
    "vitest": "^0.34.0"
  }
}
```

---

## æ”¹è¨‚å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|----------|------|---------|-------|
| 1.0 | 2025-10-12 | åˆç‰ˆä½œæˆ | Claude + djinn |

---

**END OF DOCUMENT**
